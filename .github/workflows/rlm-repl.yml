name: RLM REPL Executor

# This workflow executes arbitrary Python/Node code snippets
# Used by the RLM orchestration sample for secure remote code execution

on:
  workflow_dispatch:
    inputs:
      code:
        description: "Code to execute"
        required: true
        type: string
      language:
        description: "Programming language (python or node)"
        required: false
        default: "python"
        type: string
      timeout:
        description: "Execution timeout in milliseconds"
        required: false
        default: "60000"
        type: string

jobs:
  execute:
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Setup Python
        if: inputs.language == 'python'
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Setup Node.js
        if: inputs.language == 'node'
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Execute code
        id: execute
        run: |
          mkdir -p output

          # Calculate timeout in seconds (input is milliseconds)
          TIMEOUT_MS="${{ inputs.timeout }}"
          TIMEOUT_SEC=$((TIMEOUT_MS / 1000))
          if [ "$TIMEOUT_SEC" -lt 1 ]; then TIMEOUT_SEC=60; fi

          echo "Executing ${{ inputs.language }} code with ${TIMEOUT_SEC}s timeout..."

          if [ "${{ inputs.language }}" == "python" ]; then
            # Write code to file (using base64 to handle special chars)
            echo '${{ inputs.code }}' > /tmp/script.py
            
            # Execute with timeout, capture output
            set +e
            timeout ${TIMEOUT_SEC}s python /tmp/script.py > output/stdout.txt 2> output/stderr.txt
            EXIT_CODE=$?
            set -e
          else
            # Node.js execution
            echo '${{ inputs.code }}' > /tmp/script.js
            
            set +e
            timeout ${TIMEOUT_SEC}s node /tmp/script.js > output/stdout.txt 2> output/stderr.txt
            EXIT_CODE=$?
            set -e
          fi

          # Build JSON output (escape for JSON)
          STDOUT=$(cat output/stdout.txt | jq -Rs .)
          STDERR=$(cat output/stderr.txt | jq -Rs .)

          if [ $EXIT_CODE -eq 0 ]; then
            echo "{\"output\": ${STDOUT}, \"error\": null, \"exitCode\": 0}" > output/result.json
          else
            echo "{\"output\": ${STDOUT}, \"error\": ${STDERR}, \"exitCode\": ${EXIT_CODE}}" > output/result.json
          fi

          echo "=== Result ==="
          cat output/result.json

      - name: Upload output artifact
        uses: actions/upload-artifact@v4
        with:
          name: repl-output
          path: output/result.json
          retention-days: 1
