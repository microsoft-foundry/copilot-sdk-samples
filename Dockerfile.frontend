# syntax=docker/dockerfile:1
FROM node:22-slim AS base

WORKDIR /app

# Install pnpm
RUN corepack enable && corepack prepare pnpm@9.15.0 --activate

# ============================================
# Dependencies stage - install node_modules
# ============================================
FROM base AS deps

WORKDIR /app/frontend

COPY frontend/package.json frontend/pnpm-lock.yaml ./
RUN pnpm install --frozen-lockfile

# ============================================
# Build stage - compile React app
# ============================================
FROM base AS build

WORKDIR /app/frontend

COPY --from=deps /app/frontend/node_modules ./node_modules
COPY frontend/ .

RUN pnpm build

# ============================================
# Production stage - serve static files with nginx + API proxy
# ============================================
FROM nginx:alpine AS production

# Install envsubst for runtime environment variable substitution
RUN apk add --no-cache gettext

# Copy nginx config template (BACKEND_URL and BACKEND_HOST will be substituted at container startup)
COPY nginx.conf.template /etc/nginx/templates/default.conf.template

# Copy built assets from build stage
COPY --from=build /app/frontend/dist /usr/share/nginx/html

# Default backend URL for local testing (overridden by Container Apps env var)
ENV BACKEND_URL=http://localhost:3001
ENV BACKEND_HOST=localhost:3001

EXPOSE 80

# Extract BACKEND_HOST from BACKEND_URL and use envsubst to substitute environment variables in nginx config
CMD ["/bin/sh", "-c", "export BACKEND_HOST=$(echo $BACKEND_URL | sed 's|^https\\?://||' | sed 's|/.*||') && envsubst '${BACKEND_URL} ${BACKEND_HOST}' < /etc/nginx/templates/default.conf.template > /etc/nginx/conf.d/default.conf && nginx -g 'daemon off;'"]
